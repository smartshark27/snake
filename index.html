<!DOCTYPE html>
<html>

<head>
    <title>Snakey</title>
    <meta name="viewport" content="user-scalable=no" />
</head>

<body>

    <svg id="canvas"
        style="touch-action: manipulation; position: absolute; left: 0; top: 0; font-family: 'Lucida Console', Monaco, monospace;"
        onload="handleLoad()" onresize="fitToScreen()" onclick="handleMouseClick(event)">
        <rect id="background" x="0" y="0" width="1" height="1" fill="white" />
        <text id="messageTextbox" dominant-baseline="middle" text-anchor="middle" x="50%" y="10%" font-size="16">Tap to
            start</text>
        <circle id="snakeHead" cx="50%" cy="50%" r="20" fill="green" />
        <circle id="snakeBody1" cx="200" cy="200" r="20" fill="orange" />
    </svg>

    <script>
        const FPS = 24;
        const STEP_DISTANCE = 2;

        var gameStarted = false;
        var snakeBodyPartIDs = ["snakeBody1"];
        var snakeHeadVelocityX, snakeHeadVelocityY;

        function handleLoad() {
            fitToScreen();
            const snakeHead = document.getElementById('snakeHead');
            snakeHead.setAttribute('cx', window.innerWidth / 2);
            snakeHead.setAttribute('cy', window.innerHeight / 2);
        }

        function fitToScreen() {
            const width = window.innerWidth;
            const height = window.innerHeight;

            const canvas = document.getElementById('canvas');
            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);

            const background = document.getElementById('background');
            background.setAttribute('width', width);
            background.setAttribute('height', height);
        }

        function handleMouseClick(event) {
            removeMessage();
            const clickX = event.clientX;
            const clickY = event.clientY;
            snakeHead = document.getElementById('snakeHead');
            [snakeHeadVelocityX, snakeHeadVelocityY] = calculateVelocity(snakeHead, clickX, clickY);
            if (!gameStarted) {
                startGame();
            }
        }

        function removeMessage() {
            messageTextbox = document.getElementById("messageTextbox");
            messageTextbox.textContent = "";
        }

        function calculateVelocity(object, targetX, targetY) {
            const [x, y] = getPosition(object);
            const displacementX = x - targetX;
            const displacementY = y - targetY;
            const angle = Math.atan(displacementY / displacementX);
            const speedX = Math.cos(angle) * STEP_DISTANCE;
            const speedY = Math.sin(angle) * STEP_DISTANCE;
            const velocityX = (targetX >= x) ? speedX : -speedX
            const velocityY = (targetX >= x) ? speedY : -speedY
            return [velocityX, velocityY];
        }

        function getPosition(object) {
            const x = Number(object.getAttribute('cx'));
            const y = Number(object.getAttribute('cy'));
            return [x, y];
        }

        async function startGame() {
            gameStarted = true;
            while (gameStarted) {
                await sleep(Math.floor(1000 / FPS));
                moveSnake();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function moveSnake() {
            var part = document.getElementById('snakeHead');
            moveSnakePart(part, snakeHeadVelocityX, snakeHeadVelocityY);
            var [targetX, targetY] = getPosition(part);
            for (id of snakeBodyPartIDs) {
                const part = document.getElementById(id);
                const [velocityX, velocityY] = calculateVelocity(part, targetX, targetY);
                moveSnakePart(part, velocityX, velocityY);
                [targetX, targetY] = getPosition(part);
            }
        }

        function moveSnakePart(part, velocityX, velocityY) {
            const [x, y] = getPosition(part);
            const newX = x + velocityX;
            const newY = y + velocityY;

            part.setAttribute('cx', newX);
            part.setAttribute('cy', newY);
        }
    </script>

</body>

</html>